<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View and Save Data to Firebase</title>
    <!-- Add Firebase SDKs from the CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginButton">Login</button>

    <h2>Update Tally</h2>
    <button id="updateCostButton">Update Cost</button>
    <button id="updateGhgsButton">Update GHGs</button>
    <button id="updateComfortButton">Update Comfort</button>
    <button id="updateEquipmentButton">Update Equipment</button>

    <h2>Load Data</h2>
    <button id="loadDataButton">Load Data</button>
    <div id="dataContainer"></div>

    <h2>Download CSV</h2>
    <button id="downloadCsvButton">Download CSV</button>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyATFx-WHCXHC2uA0FZZwIcPO7LAjRh8Wjg",
            authDomain: "energy-coaching-cbbc5.firebaseapp.com",
            databaseURL: "https://energy-coaching-cbbc5-default-rtdb.firebaseio.com",
            projectId: "energy-coaching-cbbc5",
            storageBucket: "energy-coaching-cbbc5.appspot.com",
            messagingSenderId: "85932482016",
            appId: "1:85932482016:web:9852865b84481d33f41f85",
            measurementId: "G-DWJ540T6WE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Function to log in user
        function loginUser(email, password) {
            return auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("User signed in: ", userCredential.user);
                    alert("User signed in successfully");
                })
                .catch((error) => {
                    console.error("Error signing in: ", error);
                    alert("Error signing in: " + error.message);
                });
        }

        // Add event listener to the login button
        document.getElementById('loginButton').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginUser(email, password);
        });

        // Function to update tally
        function updateTally(point) {
            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const tallyRef = database.ref(`${point}/${userId}`);

                tallyRef.transaction((currentValue) => {
                    return (currentValue || 0) + 1;
                }).then(() => {
                    console.log(`${point.charAt(0).toUpperCase() + point.slice(1)} tally updated successfully`);
                }).catch((error) => {
                    console.error(`Error updating ${point}: `, error);
                    alert(`Error updating ${point}: ` + error.message);
                });
            } else {
                alert("You need to be signed in to update the tally");
            }
        }

        // Add event listeners to the update tally buttons
        document.getElementById('updateCostButton').addEventListener('click', () => updateTally('cost'));
        document.getElementById('updateGhgsButton').addEventListener('click', () => updateTally('ghgs'));
        document.getElementById('updateComfortButton').addEventListener('click', () => updateTally('comfort'));
        document.getElementById('updateEquipmentButton').addEventListener('click', () => updateTally('equipment'));

        // Function to convert JSON to CSV
        function jsonToCsv(jsonData) {
            const csvRows = [];
            const headers = Object.keys(jsonData[0]);
            csvRows.push(headers.join(','));

            for (const row of jsonData) {
                const values = headers.map(header => {
                    const escape = ('' + row[header]).replace(/"/g, '\\"');
                    return `"${escape}"`;
                });
                csvRows.push(values.join(','));
            }

            return csvRows.join('\n');
        }

        // Function to download CSV
        function downloadCsv(csvContent, filename = 'data.csv') {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Function to load data
        function loadData() {
            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const dataContainer = document.getElementById('dataContainer');
                dataContainer.innerHTML = '';
                const points = ['cost', 'ghgs', 'comfort', 'equipment'];
                const promises = points.map(point => database.ref(`${point}/${userId}`).once('value'));

                Promise.all(promises)
                    .then(snapshots => {
                        snapshots.forEach((snapshot, index) => {
                            const value = snapshot.val() || 0;
                            const dataElement = document.createElement('div');
                            dataElement.textContent = `${points[index].charAt(0).toUpperCase() + points[index].slice(1)}: ${value}`;
                            dataContainer.appendChild(dataElement);
                        });
                    })
                    .catch((error) => {
                        console.error("Error loading data: ", error);
                        alert("Error loading data: " + error.message);
                    });
            } else {
                alert("You need to be signed in to load the data");
            }
        }

        // Function to download data as CSV
        function downloadCsvData() {
            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const points = ['cost', 'ghgs', 'comfort', 'equipment'];
                const promises = points.map(point => database.ref(`${point}/${userId}`).once('value'));

                Promise.all(promises)
                    .then(snapshots => {
                        const data = {};
                        snapshots.forEach((snapshot, index) => {
                            data[points[index]] = snapshot.val() || 0;
                        });
                        const csvContent = jsonToCsv([data]);
                        downloadCsv(csvContent);
                    })
                    .catch((error) => {
                        console.error("Error downloading data: ", error);
                        alert("Error downloading data: " + error.message);
                    });
            } else {
                alert("You need to be signed in to download the data");
            }
        }

        // Add event listener to the load data button
        document.getElementById('loadDataButton').addEventListener('click', loadData);

        // Add event listener to the download CSV button
        document.getElementById('downloadCsvButton').addEventListener('click', downloadCsvData);
    </script>
</body>
</html>
